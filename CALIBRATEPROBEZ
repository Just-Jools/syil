Copyright (c) 2024 Toolpath Labs Inc., Justin Gray and Josh Smith

(CALIBRATEZ)
(THIS MACRO ASSUMES THAT YOU HAVE PUT YOUR GAUGE TOOL IN THE SPINDLE)
(  AND MANUALLY JOGGED UP TILL YOUR REFERENCE ARTIFACT CAN JUST BARELY SLIDE UNDER THE TOOL.)
(  THE MACRO WILL SAVE THE XY LOCATION FOR FUTURE USE AND STORE THE REFERENCE HEIGHT OFFSET)

(Argument A -> #1 is the approximate length of your probe)
(Argument B -> #2 turns on/off full calibration: default is full calibration)

(load probe config)
G65 "PROBECONFIG"

(important local variables)
#100 = @100             (TOOL NUMBER PROVIDED BY PROBECONFIG MACRO)

#108 = @108             (PROBE BACKOFF DISTANCE PROVIDED BY PROBECONFIG MACRO)

#104 = @104             (FAST PROBE SPEED PROVIDED BY PROBECONFIG MACRO)
#105 = @105             (SLOW PROBE SPEED PROVIDED BY PROBECONFIG MACRO)
#106 = @106             (PROBE CLEARANCE DISTANCE)
#108 = @108             (PROBE BACKOFF DISTANCE)
#109 = @109             (MASTER TOOL GAUGE LENGTH)

IF [B==0]
  MSG_OK["CALIBRATE PROBE", "ZERO MASTER GAUGE TOOL ON CALIBRATION ARTIFACT AND LEAVE IT THERE",""]

  #120 = R_ABS_COOR[0,3] (GET MACHINE Z COORDINATE WHICH SHOULD BE THE TOP OF A 123 BLOCK)

  (STORE THE CURRENT POSITION TO G54P99 FOR FUTURE FAST CALIBRATION)
  W_G54EXP_COOR[0,99,1,R_ABS_COOR[0,1]]
  W_G54EXP_COOR[0,99,2,R_ABS_COOR[0,1]]
ELSEIF                   (FAST CALIBRATION)
  MSG_OK["CALIBRATE PROBE", "INSTALL CALIBRATION ARTIFACT IN REFERENCE LOCATION",""]
  #120 = @110            (PREVIOUSLY STORED REFERENCE HEIGHT)
END_IF

(COMMAND A TOOL CHANGE)
T#100 M6                (BRING THE MACHINE UP TO TOOL CHANGE HEIGHT)
#121 = R_MACH_COOR[0,3] (GET MACHINE Z COORDINATE AFTER TOOL CHANGE)

IF [B==0]
  (TELL THE PERSON TO PUT THE PROBE INTO THE SPINDLE)
  MSG_OK["INSTALL PROBE", "SWITCH TO MPG MODE AND INSTALL THE PROBE THEN SWITCH BACK AND HIT CYCLE START; T#100",""]
END_IF

#123 = #121 - #120                     (DELTA DISTANCE WE HAVE MOVED)

IF [#1 > 0]                            (AN APPROXIMATE PROBE LENGTH WAS GIVEN)
  #124 = [#123 - #1 - #106]            (A SAFE DISTANCE TO MOVE QUICKLY BACK DOWN TO)
  G31 G91 P2 Z-[#124] F[3*#104]        (MOVE FAST TO A SAFE HEIGHT ABOVE THE TOOLSETTER)

  IF[R_SKIP[0,1] == 1]                 (CHECK THAT THE PROBE HAS NOT TRIGGERED)
    ALARM["PROBE TRIGGERED EARLY, DURING RAPID MOVE DOWN TO REFERENCE HEIGHT"]
  END_IF

  #123 = [#1 + 2*#106]                 (RESET OUR MOVE DISTANCE TO BE A BIT MORE THAN WHATS LEFT TO GO BEFORE TRIGGERING) 
END_IF

(Probe Z ALL TEH BACK TO 123 BLOCK)
G31 G91 P2 Z-[#123] F#104

(Check that the probe has triggered)
IF[R_SKIP[0,1] == 1]
  G91 G01 Z[#108]                      (BACK OFF)
  G31 G91 P2 Z-[2*108] F#105           (PROBE Z AT SLOW SPEED)
  #125 = R_SKIP[0,203]                 (GET MACHINE X COORDINATE)
  G91 G01 Z[#108]                      (BACK OFF)
  #126 = #[#125-#120+#109]             (PROBE LENGTH CALCULATION, ACCOUNTING FOR GAUGE TOOL LENGTH)
  W_TOOL_DATA[0,#100,3,#126]           (STORE PROBE LENGTH)
ELSE
  ALARM["FAILED TO PROBE PART WITHIN SPECIFIED DISTANCE",""]
END_IF


G90

M99